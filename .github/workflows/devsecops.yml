name: DevSecOps Pipeline

on: [push]

jobs:
  build-secure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Generate App Token  
        uses: actions/create-github-app-token@v1  
        id: app-token  
        with:  
          app-id: ${{ secrets.ZAP_APP_ID }}  
          private-key: ${{ secrets.ZAP_APP_PRIVATE_KEY }}  
          
      - name: Build Docker Image
        run: docker build -t my-secure-app:${{ github.sha }} .

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'my-secure-app:${{ github.sha }}'
          format: 'table'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Run Container for DAST
        # Nota: Si tu app tarda en levantar, 5 segundos puede ser poco.
        # Considera usar 'curl' en un loop para esperar hasta que responda.
        run: |
          docker run -d --network host --name test-container my-secure-app:${{ github.sha }}
          sleep 10 

      - name: OWASP ZAP Baseline Scan  
        uses: zaproxy/action-baseline@v0.15.0  
        with:  
          target: 'http://localhost:5000'  
          # AQUÍ ESTÁ LA MAGIA:  
          # En lugar de secrets.GITHUB_TOKEN, usamos el token generado por la App  
          token: ${{ steps.app-token.outputs.token }}  
          fail_action: true   
          cmd_options: |
            chmod a+rwx '/zap/wrk/zap.yaml'
          allow_issue_writing: true  
          
      - name: Upload Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: zap_report.html
          path: .
          retention-days: 1
